name: publish

on: [push, workflow_dispatch]

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Check for changes
        id: changes-check
        run: |
          if git diff --quiet HEAD~1 HEAD -- src/partial_json_parser/version.py; then
            echo "CHANGED=false" >> $GITHUB_OUTPUT
          else
            echo "CHANGED=true" >> $GITHUB_OUTPUT
          fi
    outputs:
      CHANGED: ${{ steps.changes-check.outputs.CHANGED }}
  publish:
    runs-on: ubuntu-latest
    needs: diff
    environment: release
    if: needs.diff.outputs.CHANGED == 'true'
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up python
        uses: astral-sh/setup-uv@v5
        with:
          python-version: 3.13
      - name: Build package
        run: |
          python src/overrides.py 3.6
          uv build
      - name: Publish to PyPI
        continue-on-error: true
        run: uv publish
